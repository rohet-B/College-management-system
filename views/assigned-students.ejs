<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Assigned Students - <%= teacher.Full_name %></title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">
  <div class="container mt-5">
    <h2 class="mb-4">Assigned Students for <%= teacher.Full_name %></h2>

    <form method="get" action="">
      <div class="mb-3">
        <label for="subject" class="form-label">Select Subject:</label>
        <select
          id="subject"
          class="form-select"
          onchange="location.href='/teacher/assigned-students/<%= teacher.teacherID %>/' + encodeURIComponent(this.value)"
        >
          <option disabled selected>Select a Subject</option>
          <% subjects.forEach(sub => { %>
            <option value="<%= sub %>" <%= selectedSubject === sub ? 'selected' : '' %>><%= sub %></option>
          <% }) %>
        </select>
      </div>
    </form>

    <form method="post" action="/teacher/assigned-students/<%= teacher.teacherID %>/<%= encodeURIComponent(selectedSubject || '') %>/update">
      <% if (assignedStudents.length > 0 && selectedSubject) { %>
        <table class="table table-bordered">
          <thead>
            <tr>
              <th>Student ID</th>
              <th>Full Name</th>
              <% 
                let sampleStudent = assignedStudents[0]; 
                let subjectEntry = sampleStudent.subjects_with_assessments.find(s => 
                  typeof s.subject === "string" && s.subject.trim().toLowerCase() === selectedSubject.trim().toLowerCase()
                );
                if (subjectEntry && subjectEntry.assessments) {
                  subjectEntry.assessments.forEach(a => { 
              %>
                <th><%= a.type %></th>
              <%   }) 
                } 
              %>
            </tr>
          </thead>
          <tbody>
            <% assignedStudents.forEach(student => {
                let subjectEntry = student.subjects_with_assessments.find(s => 
                  typeof s.subject === "string" && s.subject.trim().toLowerCase() === selectedSubject.trim().toLowerCase()
                );
                if (subjectEntry && subjectEntry.assessments) {
            %>
              <tr>
                <td><%= student.studentID %></td>
                <td><%= student.Full_name %></td>
                <% subjectEntry.assessments.forEach(a => { %>
                  <td>
                    <input
                      type="number"
                      class="form-control"
                      name="<%= student.studentID + '_' + a.type %>"
                      value="<%= a.marks %>"
                    />
                  </td>
                <% }) %>
              </tr>
            <% } }) %>
          </tbody>
        </table>
      <% } %>

      <!-- Always visible buttons -->
      <div class="d-flex justify-content-center gap-3 mt-4">
        <a href="/teacher/dashboard/<%= teacher.teacherID %>" class="btn btn-secondary px-4">Back to Dashboard</a>
        <button type="submit" class="btn btn-primary px-4">Save Marks</button>
      </div>
    </form>
  </div>
</body>
</html>
